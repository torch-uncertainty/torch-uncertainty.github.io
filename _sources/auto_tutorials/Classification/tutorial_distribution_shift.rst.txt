
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_tutorials/Classification/tutorial_distribution_shift.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_tutorials_Classification_tutorial_distribution_shift.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_tutorials_Classification_tutorial_distribution_shift.py:


Evaluating Model Performance Under Distribution Shift with TorchUncertainty
===========================================================================

In this tutorial, we explore how to assess a model's robustness when faced with distribution shifts.
Specifically, we will:

- Shortly train a **ResNet18** model on the standard **CIFAR-10** dataset.
- Evaluate its performance on both the original CIFAR-10 test set and a corrupted version of CIFAR-10 to simulate distribution shift.
- Analyze the model's performance and robustness under these conditions.

By the end of this tutorial, you will understand how to use TorchUncertainty to evaluate and interpret model behavior under distribution shifts.

.. GENERATED FROM PYTHON SOURCE LINES 17-22

Imports and Setup
-----------------

First, we need to import the necessary libraries and set up our environment.
This includes importing PyTorch, TorchUncertainty components, and TorchUncertainty's Trainer (built on top of Lightning's).

.. GENERATED FROM PYTHON SOURCE LINES 22-30

.. code-block:: Python


    from torch import nn, optim

    from torch_uncertainty import TUTrainer
    from torch_uncertainty.datamodules import CIFAR10DataModule
    from torch_uncertainty.models.classification.resnet import resnet
    from torch_uncertainty.routines.classification import ClassificationRoutine








.. GENERATED FROM PYTHON SOURCE LINES 31-39

DataModule Setup
----------------

TorchUncertainty provides convenient DataModules for standard datasets like CIFAR-10.
DataModules handle data loading, preprocessing, and batching, simplifying the data pipeline. Each datamodule
also include the corresponding out-of-distribution and distribution shift datasets, which are then used by the routine.
For CIFAR-10, the corresponding distribution-shift dataset is CIFAR-10C as used in the community.
To enable Distribution Shift evaluation, activate the `eval_shift` flag as done below.

.. GENERATED FROM PYTHON SOURCE LINES 39-49

.. code-block:: Python


    # Initialize the CIFAR-10 DataModule
    datamodule = CIFAR10DataModule(
        root="./data",
        batch_size=512,
        num_workers=8,
        eval_shift=True,
        shift_severity=5,  # Set severity level of the corruption (1 to 5): max-strength!
    )








.. GENERATED FROM PYTHON SOURCE LINES 50-59

CIFAR-10C
---------

CIFAR-10C is a transformed version of CIFAR-10 test set. Dan Hendrycks and Thomas Dietterich applied computer vision
transforms, known as corruptions to degrade the quality of the image and test deep learning models in adverse conditions.
There are 15 (+4 optional) corruptions in total, including noise, blur, weather effects, etc. Each corruption has 5 different
levels of severity ranging from small corruptions to very strong effects on the image. You can set the desired corruption level with
the shift-severity argument. We refer to [1] for more details.
You can get a more detailed overview and examples of the corruptions on the corresponding tutorial.

.. GENERATED FROM PYTHON SOURCE LINES 59-68

.. code-block:: Python


    # These lines are usually not necessary (they are called by the Trainer),
    # but we want to get access to the dataset before training
    datamodule.prepare_data()
    datamodule.setup("test")

    # Let's check the CIFAR-10C, it should contain (15+4)*10000 images for the selected severity level.
    print(datamodule.shift)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0.00/170M [00:00<?, ?B/s]      0%|          | 32.8k/170M [00:00<09:59, 284kB/s]      0%|          | 98.3k/170M [00:00<06:42, 424kB/s]      0%|          | 393k/170M [00:00<02:27, 1.15MB/s]      1%|          | 950k/170M [00:00<01:17, 2.18MB/s]      1%|          | 2.03M/170M [00:00<00:39, 4.25MB/s]      2%|▏         | 2.95M/170M [00:00<00:31, 5.33MB/s]      3%|▎         | 4.98M/170M [00:00<00:17, 9.35MB/s]      5%|▌         | 8.72M/170M [00:01<00:09, 16.7MB/s]      7%|▋         | 11.7M/170M [00:01<00:08, 18.8MB/s]     10%|▉         | 16.5M/170M [00:01<00:05, 26.5MB/s]     12%|█▏        | 20.6M/170M [00:01<00:04, 30.7MB/s]     14%|█▍        | 24.5M/170M [00:01<00:05, 29.2MB/s]     17%|█▋        | 29.3M/170M [00:01<00:04, 33.8MB/s]     20%|█▉        | 33.9M/170M [00:01<00:03, 37.1MB/s]     22%|██▏       | 37.7M/170M [00:01<00:03, 33.4MB/s]     25%|██▍       | 42.1M/170M [00:01<00:03, 36.0MB/s]     27%|██▋       | 46.6M/170M [00:02<00:03, 33.8MB/s]     30%|███       | 51.2M/170M [00:02<00:03, 36.9MB/s]     33%|███▎      | 55.8M/170M [00:02<00:02, 39.2MB/s]     35%|███▌      | 59.8M/170M [00:02<00:03, 35.0MB/s]     38%|███▊      | 64.2M/170M [00:02<00:02, 37.2MB/s]     40%|████      | 68.7M/170M [00:02<00:02, 39.3MB/s]     43%|████▎     | 72.8M/170M [00:02<00:02, 35.2MB/s]     45%|████▌     | 77.1M/170M [00:02<00:02, 37.3MB/s]     48%|████▊     | 81.8M/170M [00:03<00:02, 34.9MB/s]     51%|█████     | 86.5M/170M [00:03<00:02, 37.7MB/s]     54%|█████▎    | 91.2M/170M [00:03<00:01, 40.2MB/s]     56%|█████▌    | 95.4M/170M [00:03<00:02, 35.9MB/s]     58%|█████▊    | 99.6M/170M [00:03<00:01, 37.6MB/s]     61%|██████    | 104M/170M [00:03<00:01, 34.6MB/s]      64%|██████▍   | 109M/170M [00:03<00:01, 38.0MB/s]     66%|██████▋   | 113M/170M [00:03<00:01, 39.1MB/s]     69%|██████▊   | 117M/170M [00:03<00:01, 35.1MB/s]     71%|███████▏  | 122M/170M [00:04<00:01, 37.5MB/s]     74%|███████▍  | 126M/170M [00:04<00:01, 35.2MB/s]     77%|███████▋  | 131M/170M [00:04<00:01, 38.5MB/s]     80%|███████▉  | 136M/170M [00:04<00:00, 39.6MB/s]     82%|████████▏ | 140M/170M [00:04<00:00, 35.4MB/s]     85%|████████▍ | 144M/170M [00:04<00:00, 37.8MB/s]     87%|████████▋ | 149M/170M [00:04<00:00, 40.7MB/s]     90%|████████▉ | 153M/170M [00:04<00:00, 36.2MB/s]     92%|█████████▏| 158M/170M [00:05<00:00, 37.9MB/s]     95%|█████████▌| 162M/170M [00:05<00:00, 35.1MB/s]     98%|█████████▊| 167M/170M [00:05<00:00, 38.1MB/s]    100%|██████████| 170M/170M [00:05<00:00, 31.7MB/s]
      0%|          | 0.00/2.92G [00:00<?, ?B/s]      0%|          | 9.90M/2.92G [00:00<00:29, 98.8MB/s]      1%|          | 21.5M/2.92G [00:00<00:26, 109MB/s]       1%|          | 33.0M/2.92G [00:00<00:25, 112MB/s]      2%|▏         | 44.2M/2.92G [00:00<00:25, 111MB/s]      2%|▏         | 55.4M/2.92G [00:00<00:25, 111MB/s]      2%|▏         | 66.9M/2.92G [00:00<00:25, 113MB/s]      3%|▎         | 78.3M/2.92G [00:00<00:25, 113MB/s]      3%|▎         | 89.6M/2.92G [00:00<00:25, 112MB/s]      3%|▎         | 101M/2.92G [00:00<00:25, 111MB/s]       4%|▍         | 112M/2.92G [00:01<00:25, 112MB/s]      4%|▍         | 123M/2.92G [00:01<00:25, 112MB/s]      5%|▍         | 135M/2.92G [00:01<00:24, 113MB/s]      5%|▌         | 146M/2.92G [00:01<00:24, 113MB/s]      5%|▌         | 158M/2.92G [00:01<00:24, 111MB/s]      6%|▌         | 169M/2.92G [00:01<00:24, 112MB/s]      6%|▌         | 181M/2.92G [00:01<00:24, 113MB/s]      7%|▋         | 192M/2.92G [00:01<00:23, 114MB/s]      7%|▋         | 204M/2.92G [00:01<00:23, 114MB/s]      7%|▋         | 215M/2.92G [00:01<00:23, 113MB/s]      8%|▊         | 226M/2.92G [00:02<00:23, 113MB/s]      8%|▊         | 238M/2.92G [00:02<00:23, 113MB/s]      9%|▊         | 249M/2.92G [00:02<00:23, 113MB/s]      9%|▉         | 261M/2.92G [00:02<00:23, 113MB/s]      9%|▉         | 272M/2.92G [00:02<00:23, 113MB/s]     10%|▉         | 283M/2.92G [00:02<00:23, 113MB/s]     10%|█         | 295M/2.92G [00:02<00:23, 113MB/s]     10%|█         | 306M/2.92G [00:02<00:23, 113MB/s]     11%|█         | 317M/2.92G [00:02<00:23, 111MB/s]     11%|█▏        | 328M/2.92G [00:02<00:23, 110MB/s]     12%|█▏        | 340M/2.92G [00:03<00:23, 111MB/s]     12%|█▏        | 351M/2.92G [00:03<00:23, 112MB/s]     12%|█▏        | 362M/2.92G [00:03<00:22, 112MB/s]     13%|█▎        | 373M/2.92G [00:03<00:22, 111MB/s]     13%|█▎        | 385M/2.92G [00:03<00:22, 111MB/s]     14%|█▎        | 396M/2.92G [00:03<00:22, 110MB/s]     14%|█▍        | 407M/2.92G [00:03<00:23, 109MB/s]     14%|█▍        | 417M/2.92G [00:03<00:22, 109MB/s]     15%|█▍        | 428M/2.92G [00:03<00:22, 109MB/s]     15%|█▌        | 439M/2.92G [00:03<00:22, 109MB/s]     15%|█▌        | 450M/2.92G [00:04<00:22, 109MB/s]     16%|█▌        | 461M/2.92G [00:04<00:22, 109MB/s]     16%|█▌        | 472M/2.92G [00:04<00:22, 108MB/s]     17%|█▋        | 483M/2.92G [00:04<00:22, 107MB/s]     17%|█▋        | 494M/2.92G [00:04<00:22, 106MB/s]     17%|█▋        | 504M/2.92G [00:04<00:22, 107MB/s]     18%|█▊        | 515M/2.92G [00:04<00:22, 107MB/s]     18%|█▊        | 526M/2.92G [00:04<00:22, 106MB/s]     18%|█▊        | 536M/2.92G [00:04<00:22, 106MB/s]     19%|█▊        | 547M/2.92G [00:04<00:22, 106MB/s]     19%|█▉        | 558M/2.92G [00:05<00:22, 106MB/s]     19%|█▉        | 568M/2.92G [00:05<00:22, 106MB/s]     20%|█▉        | 579M/2.92G [00:05<00:22, 106MB/s]     20%|██        | 590M/2.92G [00:05<00:21, 107MB/s]     21%|██        | 601M/2.92G [00:05<00:21, 107MB/s]     21%|██        | 612M/2.92G [00:05<00:21, 106MB/s]     21%|██▏       | 622M/2.92G [00:05<00:21, 106MB/s]     22%|██▏       | 633M/2.92G [00:05<00:21, 105MB/s]     22%|██▏       | 643M/2.92G [00:05<00:21, 104MB/s]     22%|██▏       | 654M/2.92G [00:05<00:21, 105MB/s]     23%|██▎       | 665M/2.92G [00:06<00:21, 105MB/s]     23%|██▎       | 675M/2.92G [00:06<00:21, 103MB/s]     24%|██▎       | 686M/2.92G [00:06<00:21, 103MB/s]     24%|██▍       | 696M/2.92G [00:06<00:21, 103MB/s]     24%|██▍       | 707M/2.92G [00:06<00:21, 104MB/s]     25%|██▍       | 717M/2.92G [00:06<00:21, 104MB/s]     25%|██▍       | 728M/2.92G [00:06<00:21, 103MB/s]     25%|██▌       | 738M/2.92G [00:06<00:21, 103MB/s]     26%|██▌       | 749M/2.92G [00:06<00:21, 102MB/s]     26%|██▌       | 759M/2.92G [00:06<00:21, 102MB/s]     26%|██▋       | 769M/2.92G [00:07<00:20, 103MB/s]     27%|██▋       | 779M/2.92G [00:07<00:21, 101MB/s]     27%|██▋       | 790M/2.92G [00:07<00:21, 101MB/s]     27%|██▋       | 800M/2.92G [00:07<00:21, 97.3MB/s]     28%|██▊       | 809M/2.92G [00:07<00:22, 93.3MB/s]     28%|██▊       | 820M/2.92G [00:07<00:21, 95.9MB/s]     28%|██▊       | 830M/2.92G [00:07<00:21, 97.4MB/s]     29%|██▉       | 840M/2.92G [00:07<00:21, 97.9MB/s]     29%|██▉       | 850M/2.92G [00:07<00:20, 99.7MB/s]     29%|██▉       | 861M/2.92G [00:08<00:20, 101MB/s]      30%|██▉       | 871M/2.92G [00:08<00:20, 100MB/s]     30%|███       | 881M/2.92G [00:08<00:20, 99.8MB/s]     31%|███       | 891M/2.92G [00:08<00:20, 101MB/s]      31%|███       | 901M/2.92G [00:08<00:20, 100MB/s]     31%|███       | 911M/2.92G [00:08<00:20, 99.9MB/s]     32%|███▏      | 921M/2.92G [00:08<00:20, 98.9MB/s]     32%|███▏      | 931M/2.92G [00:08<00:20, 97.1MB/s]     32%|███▏      | 941M/2.92G [00:08<00:20, 97.6MB/s]     33%|███▎      | 951M/2.92G [00:08<00:19, 98.7MB/s]     33%|███▎      | 961M/2.92G [00:09<00:19, 98.3MB/s]     33%|███▎      | 971M/2.92G [00:09<00:19, 97.6MB/s]     34%|███▎      | 981M/2.92G [00:09<00:20, 95.8MB/s]     34%|███▍      | 990M/2.92G [00:09<00:20, 95.0MB/s]     34%|███▍      | 1.00G/2.92G [00:09<00:19, 96.0MB/s]     35%|███▍      | 1.01G/2.92G [00:09<00:19, 95.7MB/s]     35%|███▍      | 1.02G/2.92G [00:09<00:19, 96.3MB/s]     35%|███▌      | 1.03G/2.92G [00:09<00:19, 96.9MB/s]     36%|███▌      | 1.04G/2.92G [00:09<00:19, 96.5MB/s]     36%|███▌      | 1.05G/2.92G [00:09<00:19, 96.9MB/s]     36%|███▋      | 1.06G/2.92G [00:10<00:19, 95.4MB/s]     37%|███▋      | 1.07G/2.92G [00:10<00:19, 96.4MB/s]     37%|███▋      | 1.08G/2.92G [00:10<00:19, 95.3MB/s]     37%|███▋      | 1.09G/2.92G [00:10<00:19, 93.4MB/s]     38%|███▊      | 1.10G/2.92G [00:10<00:19, 93.4MB/s]     38%|███▊      | 1.11G/2.92G [00:10<00:19, 95.0MB/s]     38%|███▊      | 1.12G/2.92G [00:10<00:18, 98.3MB/s]     39%|███▊      | 1.13G/2.92G [00:10<00:23, 77.0MB/s]     39%|███▉      | 1.14G/2.92G [00:10<00:21, 82.2MB/s]     39%|███▉      | 1.15G/2.92G [00:11<00:21, 83.0MB/s]     40%|███▉      | 1.16G/2.92G [00:11<00:20, 85.1MB/s]     40%|███▉      | 1.16G/2.92G [00:11<00:20, 85.4MB/s]     40%|████      | 1.17G/2.92G [00:11<00:31, 54.8MB/s]     41%|████      | 1.18G/2.92G [00:11<00:27, 63.2MB/s]     41%|████      | 1.19G/2.92G [00:11<00:24, 71.3MB/s]     41%|████      | 1.20G/2.92G [00:11<00:21, 78.1MB/s]     42%|████▏     | 1.21G/2.92G [00:11<00:20, 83.4MB/s]     42%|████▏     | 1.22G/2.92G [00:12<00:19, 87.6MB/s]     42%|████▏     | 1.23G/2.92G [00:12<00:18, 90.2MB/s]     43%|████▎     | 1.24G/2.92G [00:12<00:18, 92.7MB/s]     43%|████▎     | 1.25G/2.92G [00:12<00:17, 95.0MB/s]     43%|████▎     | 1.26G/2.92G [00:12<00:17, 96.6MB/s]     44%|████▎     | 1.27G/2.92G [00:12<00:16, 98.4MB/s]     44%|████▍     | 1.28G/2.92G [00:12<00:16, 97.5MB/s]     44%|████▍     | 1.29G/2.92G [00:12<00:16, 98.1MB/s]     45%|████▍     | 1.30G/2.92G [00:12<00:16, 98.2MB/s]     45%|████▍     | 1.31G/2.92G [00:12<00:16, 97.6MB/s]     45%|████▌     | 1.32G/2.92G [00:13<00:16, 97.4MB/s]     46%|████▌     | 1.33G/2.92G [00:13<00:15, 99.4MB/s]     46%|████▌     | 1.34G/2.92G [00:13<00:15, 99.0MB/s]     46%|████▋     | 1.35G/2.92G [00:13<00:15, 99.9MB/s]     47%|████▋     | 1.36G/2.92G [00:13<00:15, 100MB/s]      47%|████▋     | 1.37G/2.92G [00:13<00:15, 99.1MB/s]     47%|████▋     | 1.38G/2.92G [00:13<00:15, 98.2MB/s]     48%|████▊     | 1.39G/2.92G [00:13<00:15, 98.3MB/s]     48%|████▊     | 1.40G/2.92G [00:13<00:15, 98.5MB/s]     48%|████▊     | 1.41G/2.92G [00:14<00:15, 97.9MB/s]     49%|████▊     | 1.42G/2.92G [00:14<00:15, 98.3MB/s]     49%|████▉     | 1.43G/2.92G [00:14<00:15, 98.6MB/s]     49%|████▉     | 1.44G/2.92G [00:14<00:14, 99.5MB/s]     50%|████▉     | 1.45G/2.92G [00:14<00:14, 98.4MB/s]     50%|█████     | 1.46G/2.92G [00:14<00:14, 97.5MB/s]     50%|█████     | 1.47G/2.92G [00:14<00:14, 98.2MB/s]     51%|█████     | 1.48G/2.92G [00:14<00:14, 98.2MB/s]     51%|█████     | 1.49G/2.92G [00:14<00:14, 97.5MB/s]     51%|█████▏    | 1.50G/2.92G [00:14<00:15, 92.8MB/s]     52%|█████▏    | 1.51G/2.92G [00:15<00:14, 94.7MB/s]     52%|█████▏    | 1.52G/2.92G [00:15<00:14, 95.6MB/s]     52%|█████▏    | 1.53G/2.92G [00:15<00:14, 93.9MB/s]     53%|█████▎    | 1.54G/2.92G [00:15<00:14, 94.1MB/s]     53%|█████▎    | 1.55G/2.92G [00:15<00:14, 94.0MB/s]     53%|█████▎    | 1.56G/2.92G [00:15<00:14, 95.1MB/s]     54%|█████▍    | 1.57G/2.92G [00:15<00:24, 55.4MB/s]     54%|█████▍    | 1.58G/2.92G [00:15<00:20, 64.3MB/s]     54%|█████▍    | 1.59G/2.92G [00:16<00:18, 71.9MB/s]     55%|█████▍    | 1.60G/2.92G [00:16<00:16, 77.6MB/s]     55%|█████▌    | 1.61G/2.92G [00:16<00:16, 80.6MB/s]     55%|█████▌    | 1.62G/2.92G [00:16<00:15, 85.7MB/s]     56%|█████▌    | 1.63G/2.92G [00:16<00:14, 88.0MB/s]     56%|█████▌    | 1.64G/2.92G [00:16<00:14, 91.3MB/s]     56%|█████▋    | 1.65G/2.92G [00:16<00:13, 94.2MB/s]     57%|█████▋    | 1.66G/2.92G [00:16<00:13, 94.8MB/s]     57%|█████▋    | 1.67G/2.92G [00:16<00:13, 95.9MB/s]     57%|█████▋    | 1.68G/2.92G [00:16<00:12, 95.8MB/s]     58%|█████▊    | 1.69G/2.92G [00:17<00:12, 95.8MB/s]     58%|█████▊    | 1.70G/2.92G [00:17<00:12, 97.3MB/s]     58%|█████▊    | 1.71G/2.92G [00:17<00:12, 97.8MB/s]     59%|█████▉    | 1.72G/2.92G [00:17<00:12, 99.3MB/s]     59%|█████▉    | 1.73G/2.92G [00:17<00:11, 99.9MB/s]     60%|█████▉    | 1.74G/2.92G [00:17<00:11, 99.9MB/s]     60%|█████▉    | 1.75G/2.92G [00:17<00:11, 98.4MB/s]     60%|██████    | 1.76G/2.92G [00:17<00:11, 97.7MB/s]     61%|██████    | 1.77G/2.92G [00:17<00:11, 98.4MB/s]     61%|██████    | 1.78G/2.92G [00:18<00:11, 99.5MB/s]     61%|██████▏   | 1.79G/2.92G [00:18<00:11, 100MB/s]      62%|██████▏   | 1.80G/2.92G [00:18<00:11, 100MB/s]     62%|██████▏   | 1.81G/2.92G [00:18<00:11, 100MB/s]     62%|██████▏   | 1.82G/2.92G [00:18<00:11, 99.7MB/s]     63%|██████▎   | 1.83G/2.92G [00:18<00:10, 100MB/s]      63%|██████▎   | 1.84G/2.92G [00:18<00:10, 99.5MB/s]     63%|██████▎   | 1.85G/2.92G [00:18<00:10, 99.7MB/s]     64%|██████▎   | 1.86G/2.92G [00:18<00:10, 99.7MB/s]     64%|██████▍   | 1.87G/2.92G [00:18<00:10, 98.9MB/s]     64%|██████▍   | 1.88G/2.92G [00:19<00:10, 99.2MB/s]     65%|██████▍   | 1.89G/2.92G [00:19<00:10, 101MB/s]      65%|██████▌   | 1.90G/2.92G [00:19<00:10, 99.8MB/s]     65%|██████▌   | 1.91G/2.92G [00:19<00:10, 100MB/s]      66%|██████▌   | 1.92G/2.92G [00:19<00:10, 99.0MB/s]     66%|██████▌   | 1.93G/2.92G [00:19<00:10, 98.8MB/s]     66%|██████▋   | 1.94G/2.92G [00:19<00:10, 98.0MB/s]     67%|██████▋   | 1.95G/2.92G [00:19<00:09, 98.0MB/s]     67%|██████▋   | 1.96G/2.92G [00:19<00:09, 98.7MB/s]     67%|██████▋   | 1.97G/2.92G [00:19<00:09, 98.9MB/s]     68%|██████▊   | 1.98G/2.92G [00:20<00:09, 98.9MB/s]     68%|██████▊   | 1.99G/2.92G [00:20<00:09, 98.0MB/s]     68%|██████▊   | 2.00G/2.92G [00:20<00:09, 98.9MB/s]     69%|██████▉   | 2.01G/2.92G [00:20<00:09, 98.9MB/s]     69%|██████▉   | 2.02G/2.92G [00:20<00:09, 98.7MB/s]     69%|██████▉   | 2.03G/2.92G [00:20<00:09, 98.4MB/s]     70%|██████▉   | 2.04G/2.92G [00:20<00:08, 99.9MB/s]     70%|███████   | 2.05G/2.92G [00:20<00:08, 99.4MB/s]     71%|███████   | 2.06G/2.92G [00:20<00:08, 98.5MB/s]     71%|███████   | 2.07G/2.92G [00:20<00:08, 97.5MB/s]     71%|███████   | 2.08G/2.92G [00:21<00:08, 97.7MB/s]     72%|███████▏  | 2.09G/2.92G [00:21<00:08, 96.7MB/s]     72%|███████▏  | 2.10G/2.92G [00:21<00:08, 97.5MB/s]     72%|███████▏  | 2.11G/2.92G [00:21<00:08, 97.2MB/s]     73%|███████▎  | 2.12G/2.92G [00:21<00:07, 101MB/s]      73%|███████▎  | 2.13G/2.92G [00:21<00:10, 77.5MB/s]     73%|███████▎  | 2.14G/2.92G [00:21<00:09, 82.3MB/s]     74%|███████▎  | 2.15G/2.92G [00:21<00:08, 86.6MB/s]     74%|███████▍  | 2.16G/2.92G [00:21<00:08, 90.7MB/s]     74%|███████▍  | 2.17G/2.92G [00:22<00:08, 91.8MB/s]     75%|███████▍  | 2.18G/2.92G [00:22<00:08, 92.4MB/s]     75%|███████▍  | 2.19G/2.92G [00:22<00:07, 93.9MB/s]     75%|███████▌  | 2.20G/2.92G [00:22<00:07, 95.2MB/s]     76%|███████▌  | 2.21G/2.92G [00:22<00:07, 95.6MB/s]     76%|███████▌  | 2.22G/2.92G [00:22<00:07, 96.9MB/s]     76%|███████▋  | 2.23G/2.92G [00:22<00:07, 97.2MB/s]     77%|███████▋  | 2.24G/2.92G [00:22<00:07, 97.4MB/s]     77%|███████▋  | 2.25G/2.92G [00:22<00:06, 99.0MB/s]     77%|███████▋  | 2.26G/2.92G [00:22<00:06, 97.9MB/s]     78%|███████▊  | 2.27G/2.92G [00:23<00:06, 97.7MB/s]     78%|███████▊  | 2.28G/2.92G [00:23<00:06, 98.3MB/s]     78%|███████▊  | 2.29G/2.92G [00:23<00:06, 98.3MB/s]     79%|███████▊  | 2.30G/2.92G [00:23<00:06, 98.4MB/s]     79%|███████▉  | 2.31G/2.92G [00:23<00:06, 99.2MB/s]     79%|███████▉  | 2.32G/2.92G [00:23<00:05, 100MB/s]      80%|███████▉  | 2.33G/2.92G [00:23<00:05, 99.6MB/s]     80%|████████  | 2.34G/2.92G [00:23<00:05, 98.8MB/s]     80%|████████  | 2.35G/2.92G [00:23<00:05, 99.7MB/s]     81%|████████  | 2.36G/2.92G [00:23<00:05, 99.5MB/s]     81%|████████  | 2.37G/2.92G [00:24<00:05, 99.5MB/s]     81%|████████▏ | 2.38G/2.92G [00:24<00:05, 100MB/s]      82%|████████▏ | 2.39G/2.92G [00:24<00:05, 99.8MB/s]     82%|████████▏ | 2.40G/2.92G [00:24<00:05, 99.8MB/s]     82%|████████▏ | 2.41G/2.92G [00:24<00:05, 98.7MB/s]     83%|████████▎ | 2.42G/2.92G [00:24<00:05, 99.2MB/s]     83%|████████▎ | 2.43G/2.92G [00:24<00:04, 100MB/s]      84%|████████▎ | 2.44G/2.92G [00:24<00:04, 101MB/s]     84%|████████▍ | 2.45G/2.92G [00:24<00:04, 101MB/s]     84%|████████▍ | 2.46G/2.92G [00:24<00:04, 101MB/s]     85%|████████▍ | 2.47G/2.92G [00:25<00:04, 100MB/s]     85%|████████▍ | 2.48G/2.92G [00:25<00:04, 100MB/s]     85%|████████▌ | 2.49G/2.92G [00:25<00:04, 101MB/s]     86%|████████▌ | 2.50G/2.92G [00:25<00:04, 101MB/s]     86%|████████▌ | 2.51G/2.92G [00:25<00:04, 101MB/s]     86%|████████▋ | 2.52G/2.92G [00:25<00:03, 101MB/s]     87%|████████▋ | 2.53G/2.92G [00:25<00:03, 98.8MB/s]     87%|████████▋ | 2.54G/2.92G [00:25<00:03, 97.6MB/s]     87%|████████▋ | 2.55G/2.92G [00:25<00:03, 97.1MB/s]     88%|████████▊ | 2.56G/2.92G [00:25<00:03, 98.3MB/s]     88%|████████▊ | 2.57G/2.92G [00:26<00:03, 98.0MB/s]     88%|████████▊ | 2.58G/2.92G [00:26<00:03, 99.3MB/s]     89%|████████▊ | 2.59G/2.92G [00:26<00:03, 100MB/s]      89%|████████▉ | 2.60G/2.92G [00:26<00:03, 99.5MB/s]     89%|████████▉ | 2.61G/2.92G [00:26<00:03, 99.8MB/s]     90%|████████▉ | 2.62G/2.92G [00:26<00:02, 100MB/s]      90%|█████████ | 2.63G/2.92G [00:26<00:02, 101MB/s]     90%|█████████ | 2.64G/2.92G [00:26<00:02, 101MB/s]     91%|█████████ | 2.65G/2.92G [00:26<00:02, 101MB/s]     91%|█████████ | 2.66G/2.92G [00:27<00:02, 101MB/s]     92%|█████████▏| 2.67G/2.92G [00:27<00:02, 100MB/s]     92%|█████████▏| 2.68G/2.92G [00:27<00:02, 100MB/s]     92%|█████████▏| 2.69G/2.92G [00:27<00:02, 100MB/s]     93%|█████████▎| 2.70G/2.92G [00:27<00:02, 99.8MB/s]     93%|█████████▎| 2.71G/2.92G [00:27<00:02, 98.9MB/s]     93%|█████████▎| 2.72G/2.92G [00:27<00:01, 100MB/s]      94%|█████████▎| 2.73G/2.92G [00:27<00:01, 99.2MB/s]     94%|█████████▍| 2.74G/2.92G [00:27<00:01, 99.5MB/s]     94%|█████████▍| 2.75G/2.92G [00:27<00:01, 99.6MB/s]     95%|█████████▍| 2.76G/2.92G [00:28<00:01, 99.3MB/s]     95%|█████████▍| 2.77G/2.92G [00:28<00:01, 98.2MB/s]     95%|█████████▌| 2.78G/2.92G [00:28<00:01, 98.4MB/s]     96%|█████████▌| 2.79G/2.92G [00:28<00:01, 97.7MB/s]     96%|█████████▌| 2.80G/2.92G [00:28<00:01, 98.6MB/s]     96%|█████████▋| 2.81G/2.92G [00:28<00:01, 98.3MB/s]     97%|█████████▋| 2.82G/2.92G [00:28<00:00, 98.8MB/s]     97%|█████████▋| 2.83G/2.92G [00:28<00:00, 98.9MB/s]     97%|█████████▋| 2.84G/2.92G [00:28<00:00, 99.8MB/s]     98%|█████████▊| 2.85G/2.92G [00:28<00:00, 100MB/s]      98%|█████████▊| 2.86G/2.92G [00:29<00:00, 99.9MB/s]     98%|█████████▊| 2.87G/2.92G [00:29<00:00, 99.6MB/s]     99%|█████████▊| 2.88G/2.92G [00:29<00:00, 98.5MB/s]     99%|█████████▉| 2.89G/2.92G [00:29<00:00, 99.7MB/s]     99%|█████████▉| 2.90G/2.92G [00:29<00:00, 100MB/s]     100%|█████████▉| 2.91G/2.92G [00:29<00:00, 102MB/s]    100%|██████████| 2.92G/2.92G [00:29<00:00, 98.7MB/s]
    Dataset CIFAR10C
        Number of datapoints: 190000
        Root location: data/CIFAR-10-C
        StandardTransform
    Transform: Compose(
                     ToImage()
                     ToDtype(scale=True)
                     Normalize(mean=[0.4914, 0.4822, 0.4465], std=[0.2023, 0.1994, 0.201], inplace=False)
               )




.. GENERATED FROM PYTHON SOURCE LINES 69-74

Model Initialization
--------------------

We will use the ResNet18 architecture, a widely adopted convolutional neural network known for its deep residual learning capabilities.
The model is initialized with 10 output classes corresponding to the CIFAR-10 dataset categories.

.. GENERATED FROM PYTHON SOURCE LINES 74-78

.. code-block:: Python


    # Initialize the ResNet18 model with 10 output classes
    model = resnet(arch=18, in_channels=3, num_classes=10)








.. GENERATED FROM PYTHON SOURCE LINES 79-89

Define the Classification Routine
---------------------------------

The `ClassificationRoutine` is one of the most crucial building blocks in TorchUncertainty.
It streamlines the training and evaluation processes.
It integrates the model, loss function, and optimizer into a cohesive routine compatible with PyTorch Lightning's Trainer.
This abstraction simplifies the implementation of standard training loops and evaluation protocols.
To come back to what matters in this tutorial, the routine also handles the evaluation of the performance
of the model under distribution shift detection. To enable it, activate the `eval_shift` flag. Note that you can also evaluate
the Out-of-distribution detection at the same time by also setting `eval_ood` to True.

.. GENERATED FROM PYTHON SOURCE LINES 89-101

.. code-block:: Python


    # Define the loss function: Cross-Entropy Loss for multi-class classification
    criterion = nn.CrossEntropyLoss()

    # Define the optimizer: Adam optimizer with a learning rate of 0.001
    optimizer = optim.Adam(model.parameters(), lr=0.001)

    # Initialize the ClassificationRoutine with the model, number of classes, loss function, and optimizer
    routine = ClassificationRoutine(
        model=model, num_classes=10, loss=criterion, optim_recipe=optimizer, eval_shift=True
    )








.. GENERATED FROM PYTHON SOURCE LINES 102-108

Training the Model
------------------

With the routine defined, we can now set up the TUTrainer and commence training.
The TUTrainer handles the training loop, including epoch management, logging, and checkpointing.
We specify the maximum number of epochs, the precision and the device to be used.

.. GENERATED FROM PYTHON SOURCE LINES 108-117

.. code-block:: Python


    # Initialize the TUTrainer with a maximum of 10 epochs and the specified device
    trainer = TUTrainer(
        max_epochs=10, precision="16-mixed", accelerator="cuda", devices=1, enable_progress_bar=False
    )

    # Begin training the model using the CIFAR-10 DataModule
    trainer.fit(routine, datamodule=datamodule)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/chocolatine/actions-runner/_work/torch-uncertainty/torch-uncertainty/.venv/lib/python3.13/site-packages/lightning/pytorch/utilities/model_summary/model_summary.py:242: Precision 16-mixed is not supported by the model summary.  Estimated model size in MB will not be accurate. Using 32 bits instead.
    ┏━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━┓
    ┃   ┃ Name               ┃ Type                ┃ Params ┃ Mode  ┃ FLOPs ┃
    ┡━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━┩
    │ 0 │ ood_criterion      │ MaxSoftmaxCriterion │      0 │ train │     0 │
    │ 1 │ model              │ _ResNet             │ 11.2 M │ train │     0 │
    │ 2 │ loss               │ CrossEntropyLoss    │      0 │ train │     0 │
    │ 3 │ format_batch_fn    │ Identity            │      0 │ train │     0 │
    │ 4 │ val_cls_metrics    │ MetricCollection    │      0 │ train │     0 │
    │ 5 │ test_cls_metrics   │ MetricCollection    │      0 │ train │     0 │
    │ 6 │ test_id_entropy    │ Entropy             │      0 │ train │     0 │
    │ 7 │ test_shift_metrics │ MetricCollection    │      0 │ train │     0 │
    │ 8 │ mixup              │ Identity            │      0 │ train │     0 │
    └───┴────────────────────┴─────────────────────┴────────┴───────┴───────┘
    Trainable params: 11.2 M                                                        
    Non-trainable params: 0                                                         
    Total params: 11.2 M                                                            
    Total estimated model params size (MB): 44                                      
    Modules in train mode: 109                                                      
    Modules in eval mode: 0                                                         
    Total FLOPs: 0                                                                  




.. GENERATED FROM PYTHON SOURCE LINES 118-124

Evaluating on In-Distribution and Distribution-shifted Data
-----------------------------------------------------------

Now that the model is trained, we can evaluate its performance on the original in-distribution test set,
as well as the distribution-shifted set. Typing the next line will automatically compute the in-distribution
metrics as well as their values on the distribution-shifted set.

.. GENERATED FROM PYTHON SOURCE LINES 124-128

.. code-block:: Python


    # Evaluate the trained model on the original CIFAR-10 test set and on CIFAR-10C
    results = trainer.test(routine, datamodule=datamodule)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃ Test metric  ┃      Classification       ┃
    ┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
    │     Acc      │          74.810%          │
    │    Brier     │          0.34910          │
    │   Entropy    │          0.58766          │
    │     NLL      │          0.72692          │
    └──────────────┴───────────────────────────┘
    ┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃ Test metric  ┃        Calibration        ┃
    ┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
    │     ECE      │          4.310%           │
    │     aECE     │          4.303%           │
    └──────────────┴───────────────────────────┘
    ┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃ Test metric  ┃ Selective Classification  ┃
    ┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
    │    AUGRC     │          6.318%           │
    │     AURC     │          8.356%           │
    │  Cov@5Risk   │           nan%            │
    │  Risk@80Cov  │          16.363%          │
    └──────────────┴───────────────────────────┘
    ┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃ Test metric  ┃  Distribution Shift lvl5  ┃
    ┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
    │    AUGRC     │          7.924%           │
    │     AURC     │          10.767%          │
    │     Acc      │          71.151%          │
    │    Brier     │          0.39836          │
    │  Cov@5Risk   │           nan%            │
    │     ECE      │          6.179%           │
    │     NLL      │          0.84127          │
    │  Risk@80Cov  │          20.498%          │
    │     aECE     │          6.177%           │
    └──────────────┴───────────────────────────┘
    ┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃ Test metric  ┃        Complexity         ┃
    ┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
    │    flops     │          37.90 G          │
    │    params    │          11.18 M          │
    └──────────────┴───────────────────────────┘




.. GENERATED FROM PYTHON SOURCE LINES 129-135

Distribution-shift metrics
--------------------------

The distribution shift metrics are computed only when the `eval_shift` flag of the routine is True.
In this case, the values of the metrics are shown last. They correspond to the in-distribution metrics but
computed on the distribution-shifted datasets, hence the worse results.


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (1 minutes 36.523 seconds)


.. _sphx_glr_download_auto_tutorials_Classification_tutorial_distribution_shift.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: tutorial_distribution_shift.ipynb <tutorial_distribution_shift.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: tutorial_distribution_shift.py <tutorial_distribution_shift.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: tutorial_distribution_shift.zip <tutorial_distribution_shift.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
